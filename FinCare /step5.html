<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Step 5: Life Goals - FinCARE</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGeRJkrzIjtM51OFu8_58nAlxAof0QK98",
            authDomain: "fincare-project-4015e.firebaseapp.com",
            databaseURL: "https://fincare-project-4015e-default-rtdb.firebaseio.com",
            projectId: "fincare-project-4015e",
            storageBucket: "fincare-project-4015e.firebasestorage.app",
            messagingSenderId: "415209492661",
            appId: "1:415209492661:web:683ea15a1e177fb4c52efc",
            measurementId: "G-DNG4ZMXG1J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
        });

        async function saveLifeGoals() {
            const user = auth.currentUser;
            if (!user) return;

            const nextBtn = document.getElementById('nextBtn');
            const originalText = nextBtn.innerHTML;
            nextBtn.innerText = "Setting Goals...";
            nextBtn.style.pointerEvents = "none";

            // 1. Fetching the Monthly Auto-Save Fix Amount
            const fixAmountInput = document.getElementById('monthlyFixAmount');
            const monthlyFixDeductionValue = parseFloat(fixAmountInput.value) || 0;

            const selectedGoals = [];
            const goalCards = document.querySelectorAll('.goal-card-container');

            goalCards.forEach(card => {
                const checkbox = card.querySelector('.goal-checkbox');
                if (checkbox.checked) {
                    const type = card.getAttribute('data-goal-type');
                    const amountInput = card.querySelector('.target-amount');
                    const yearInput = card.querySelector('.target-year');

                    selectedGoals.push({
                        goalName: type,
                        targetAmount: parseFloat(amountInput.value) || 0,
                        targetYear: parseInt(yearInput.value) || new Date().getFullYear() + 1,
                        currentSavings: 0 // Adding initial savings as 0 for tracking
                    });
                }
            });

            try {
                const userRef = doc(db, "users", user.uid);
                // 2. Updating Firestore with Goals and the new Fix Amount
                await updateDoc(userRef, {
                    lifeGoals: selectedGoals,
                    monthlyFixDeduction: monthlyFixDeductionValue, 
                    currentStep: 5,
                    lastUpdated: new Date()
                });
                window.location.href = "step6.html";
            } catch (error) {
                console.error("Error saving goals:", error);
                alert("Error saving data. Please try again.");
                nextBtn.innerHTML = originalText;
                nextBtn.style.pointerEvents = "auto";
            }
        }
        window.saveLifeGoals = saveLifeGoals;
    </script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f2cc0d",
                        "background-dark": "#000000",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body { font-family: 'Manrope', sans-serif; background-color: #000; }
        .glass-card { background: rgba(18, 18, 18, 0.8); border: 1px solid rgba(255, 255, 255, 0.08); }
        .goal-checkbox:checked + .goal-card-ui { border-color: #f2cc0d; background: rgba(242, 204, 13, 0.05); }
        .goal-checkbox:not(:checked) + .goal-card-ui .input-group { opacity: 0.4; pointer-events: none; }
    </style>
</head>
<body class="bg-background-dark text-white font-display">
<div class="mx-auto relative flex min-h-screen w-full max-w-[430px] flex-col">
    <div class="sticky top-0 bg-black/80 backdrop-blur-md z-30">
        <div class="flex items-center p-6 pb-2 justify-between">
            <a class="text-white flex size-10 items-center justify-center bg-white/5 rounded-full" href="step4.html">
                <span class="material-symbols-outlined text-[20px] ml-1">arrow_back_ios</span>
            </a>
            <h2 class="text-white/60 text-sm font-bold uppercase tracking-[0.2em] flex-1 text-center pr-10">Step 5 of 7</h2>
        </div>
        <div class="flex flex-col gap-3 px-6 py-4">
            <div class="flex justify-between items-end">
                <span class="text-primary text-xs font-black uppercase tracking-widest">Setup Progress</span>
                <span class="text-primary text-lg font-black italic">71%</span>
            </div>
            <div class="rounded-full bg-white/5 h-1.5 w-full overflow-hidden border border-white/5">
                <div class="h-full rounded-full bg-primary" style="width: 71.4%;"></div>
            </div>
        </div>
    </div>

    <div class="px-6 pt-6 pb-4">
        <h1 class="text-white tracking-tight text-[36px] font-extrabold leading-tight">Life Goals</h1>
        <p class="text-white/50 text-base font-medium mt-2">What are you building wealth for?</p>
    </div>

    <div class="px-6 mb-2">
        <div class="glass-card rounded-2xl p-5 border-primary/20 bg-primary/5">
            <div class="flex items-center gap-3 mb-4">
                <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-primary">event_repeat</span>
                </div>
                <div>
                    <h3 class="text-white font-bold">Monthly Auto-Save</h3>
                    <p class="text-white/40 text-[10px] uppercase font-bold tracking-tighter">Fixed amount for your goals</p>
                </div>
            </div>
            <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-primary font-bold text-lg">₹</span>
                <input id="monthlyFixAmount" class="w-full bg-black/40 border border-white/10 rounded-xl py-4 pl-10 pr-4 text-white font-black text-xl placeholder:text-white/10 focus:border-primary transition-all" placeholder="Enter fix amount" type="number"/>
            </div>
            <p class="mt-3 text-white/30 text-[11px] leading-relaxed italic">
                *This amount will be automatically distributed among your selected goals every month.
            </p>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-4 p-6 mb-32">
        <div class="goal-card-container group" data-goal-type="New Car">
            <label class="relative block cursor-pointer">
                <input checked class="goal-checkbox hidden" type="checkbox"/>
                <div class="goal-card-ui flex flex-col gap-4 rounded-2xl glass-card p-5 border-white/10 transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary text-[28px]">directions_car</span>
                            <span class="text-white text-lg font-bold">New Car</span>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 border-white/20 flex items-center justify-center group-has-[:checked]:bg-primary transition-colors">
                            <span class="material-symbols-outlined text-black text-xs font-bold group-has-[:checked]:block hidden">check</span>
                        </div>
                    </div>
                    <div class="input-group grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-white/40 uppercase font-bold">Amount (₹)</span>
                            <input class="target-amount bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white font-bold focus:border-primary outline-none" placeholder="Amount" type="number" value="1500000"/>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-white/40 uppercase font-bold">Target Year</span>
                            <input class="target-year bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white font-bold focus:border-primary outline-none" placeholder="Year" type="number" value="2026"/>
                        </div>
                    </div>
                </div>
            </label>
        </div>

        <div class="goal-card-container group" data-goal-type="New House">
            <label class="relative block cursor-pointer">
                <input checked class="goal-checkbox hidden" type="checkbox"/>
                <div class="goal-card-ui flex flex-col gap-4 rounded-2xl glass-card p-5 border-white/10 transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary text-[28px]">home</span>
                            <span class="text-white text-lg font-bold">New House</span>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 border-white/20 flex items-center justify-center group-has-[:checked]:bg-primary transition-colors">
                            <span class="material-symbols-outlined text-black text-xs font-bold group-has-[:checked]:block hidden">check</span>
                        </div>
                    </div>
                    <div class="input-group grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-white/40 uppercase font-bold">Amount (₹)</span>
                            <input class="target-amount bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white font-bold focus:border-primary outline-none" placeholder="Amount" type="number" value="25000000"/>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-white/40 uppercase font-bold">Target Year</span>
                            <input class="target-year bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white font-bold focus:border-primary outline-none" placeholder="Year" type="number" value="2030"/>
                        </div>
                    </div>
                </div>
            </label>
        </div>

        <div class="goal-card-container group" data-goal-type="Retirement">
            <label class="relative block cursor-pointer">
                <input class="goal-checkbox hidden" type="checkbox"/>
                <div class="goal-card-ui flex flex-col gap-4 rounded-2xl glass-card p-5 border-white/10 transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary text-[28px]">savings</span>
                            <span class="text-white text-lg font-bold">Retirement</span>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 border-white/20 flex items-center justify-center group-has-[:checked]:bg-primary transition-colors">
                            <span class="material-symbols-outlined text-black text-xs font-bold group-has-[:checked]:block hidden">check</span>
                        </div>
                    </div>
                    <div class="input-group grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-white/40 uppercase font-bold">Amount (₹)</span>
                            <input class="target-amount bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white font-bold focus:border-primary outline-none" placeholder="Amount" type="number"/>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-white/40 uppercase font-bold">Target Year</span>
                            <input class="target-year bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white font-bold focus:border-primary outline-none" placeholder="Year" type="number"/>
                        </div>
                    </div>
                </div>
            </label>
        </div>
    </div>

    <div class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[430px] p-6 bg-gradient-to-t from-black via-black/95 to-transparent z-40">
        <button id="nextBtn" onclick="saveLifeGoals()" class="flex w-full h-16 items-center justify-center rounded-2xl bg-primary text-black text-lg font-black tracking-widest shadow-[0_12px_40px_rgba(242,204,13,0.25)] transition-all active:scale-95">
            Next
            <span class="material-symbols-outlined font-bold ml-2">arrow_forward</span>
        </button>
    </div>
</div>
</body>
</html>
